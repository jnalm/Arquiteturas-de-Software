import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.io.IOException;
import java.sql.Connection;

public class Ativo {
	
	private ResultSet rs;
	private Connection con;
	
	public Ativo() throws SQLException, ClassNotFoundException {
	
		Class.forName("com.mysql.jdbc.Driver");
	
		con = DriverManager.getConnection("jdbc:mysql://localhost:3306/mydb?useSSL=true", "root", "1234");
	}
	
	public ResultSet getBD(String query) throws SQLException {
		Statement st = con.createStatement();
		ResultSet rs = st.executeQuery(query);
		return rs;
	}
	
	public void alterBD(String query) throws SQLException {
		Statement st = con.createStatement();
		st.executeUpdate(query);
	}
	
	public void addNewAtivo(String nome, int userLogin) throws SQLException, IOException {
		ResultSet rs = getBD("SELECT COUNT(idAtivo) FROM ativo");
		rs.next();
		int nAtivos = ((Number) rs.getObject(1)).intValue() + 1;
		String bid = YahooFinance.get(nome).getQuote().getBid().toString();
		String ask = YahooFinance.get(nome).getQuote().getAsk().toString();
		String fullname = YahooFinance.get(nome).getName();
		alterBD("INSERT INTO ativo VALUES (" + nAtivos + ",'" + fullname + "','" + nome +  "','" + ask + "','" + bid + "')");
		ResultSet rst2 = getBD("SELECT idAtivo FROM ativo WHERE Tipo = '" + nome + "'");
		rst2.next();
		int idAtivo = ((Number) rst2.getObject(1)).intValue();
		alterBD("INSERT INTO ativo_has_portfolio(Ativo_idAtivo,Portfolio_idPortfolio) " + "VALUES (" + idAtivo + "," + userLogin + ")");
	}
	
	public void addOldAtivo(String nome, int userLogin) throws SQLException, IOException {
		ResultSet rs = getBD("SELECT idAtivo FROM ativo WHERE Tipo = '" + nome + "'");
		rs.next();
		int idAtivo = ((Number) rs.getObject(1)).intValue();
		String bid = YahooFinance.get(nome).getQuote().getBid().toString();
		String ask = YahooFinance.get(nome).getQuote().getAsk().toString();
		alterBD("UPDATE ativo SET ValorVenda = '" + bid + "', ValorCompra = '" + ask + "' WHERE idAtivo = " + idAtivo);
		alterBD("INSERT INTO ativo_has_portfolio(Ativo_idAtivo,Portfolio_idPortfolio) " + "VALUES (" + idAtivo + "," + userLogin + ")");
	}
	
	public void addAtivo(String nome, int userLogin) {
		try {
			ResultSet rst = getBD("SELECT Tipo FROM ativo WHERE Tipo = '" + nome + "'");
			if(rst.next() == false) {
				addNewAtivo(nome, userLogin);
			} else {
				addOldAtivo(nome, userLogin);
			}
		} catch(Exception e) {
			System.out.println("Error: " + e);
		}
	}
	
	public void removeAtivo(int id, int userLogin) {
		try {
			alterBD("DELETE FROM ativo_has_portfolio WHERE Ativo_idAtivo = " + id + " AND Portfolio_idPortfolio = " + userLogin);
		} catch(Exception e) {
			System.out.println("Error: " + e);
		}
	}
	
	public ResultSet getPortfolio(int userLogin) {
		try {
			rs = getBD("SELECT at.idAtivo, at.Nome, at.Tipo, at.ValorCompra, at.ValorVenda FROM ativo AS at INNER JOIN ativo_has_portfolio AS ahp ON at.idAtivo = ahp.Ativo_idAtivo WHERE ahp.Portfolio_idPortfolio = " + userLogin);
		} catch(Exception e) {
			System.out.println("Error: " + e);
		}
		return rs;
	}
	
	public ResultSet getAtivosCompra(int userLogin) {
		try {
			rs = getBD("SELECT uha.Ativo_idAtivo, at.Nome, at.ValorVenda, at.ValorCompra, uha.LimiteLucro, uha.LimitePerda, uha.Montante, uha.MontanteResultante FROM utilizador_has_ativo AS uha INNER JOIN ativo AS at ON uha.Ativo_idAtivo = at.idAtivo WHERE uha.Utilizador_idUtilizador = " + userLogin + " AND uha.Estado = 'COMPRA'");
		} catch(Exception e) {
			System.out.println("Error: " + e);
		}
		return rs;
	}
	
	public ResultSet getAtivosVenda(int userLogin) {
		try {
			rs = getBD("SELECT uha.Ativo_idAtivo, at.Nome, at.ValorVenda, at.ValorCompra, uha.LimiteLucro, uha.LimitePerda, uha.Montante, uha.MontanteResultante FROM utilizador_has_ativo AS uha INNER JOIN ativo AS at ON uha.Ativo_idAtivo = at.idAtivo WHERE uha.Utilizador_idUtilizador = " + userLogin + " AND uha.Estado = 'VENDA'");
		} catch(Exception e) {
			System.out.println("Error: " + e);
		}
		return rs;
	}
	
}
